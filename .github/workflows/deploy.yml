name: Deploy to Cloud Run

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Autenticaci√≥n con Google Cloud usando Service Account Key
      # Recomendado: En el futuro, considera usar Workload Identity Federation para mayor seguridad.
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # Configurar Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Construir y subir imagen usando Cloud Build
      # Usa el archivo cloudbuild.yaml existente y pasa las variables de entorno como sustituciones
      - name: Submit Build to Cloud Build
        run: |
          gcloud builds submit --config cloudbuild.yaml \
            --substitutions=_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }},_SUPABASE_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }} \
            .

      # Desplegar la imagen construida a Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy mindops-web \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/mindops-web \
            --region us-central1 \
            --allow-unauthenticated \
            --set-env-vars NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }},NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
